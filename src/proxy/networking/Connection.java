package proxy.networking;

import proxy.exceptions.NotImplementedException;
import proxy.exceptions.ParseException;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

/**
 * Represents a bidirectional communication link between this host and a remote
 * host
 *
 * @author tjenkins
 */
public class Connection {

    private Socket connection;
    private InputStream in;
    private OutputStream out;
    private final String destination;
    private final int port;

    /**
     * Constructs a Connection class with the given destination address and port
     * number
     *
     * @param destination
     * @param port
     */
    public Connection(String destination, int port) {
        this.destination = destination;
        this.port = port;
    }

    /**
     * Constructs a Connection class from an existing socket
     *
     * @param existing_socket
     */
    public Connection(Socket existing_socket) {
        connection = existing_socket;
        port = connection.getPort();
        destination = connection.getInetAddress().getHostName();
    }

    /**
     * Queries status for this connection
     *
     * @return
     */
    public boolean isAlive() {
        return (connection.isConnected() && !connection.isClosed());
    }

    /**
     * Reads in the data portion of the HTTP Message
     *
     * @param msg
     * @throws IOException
     */
    public void readData(Message msg) throws IOException {
        boolean checkcontent = msg.contentType != null;
        if (checkcontent) {
            int by;
            try (ByteArrayOutputStream stream = new ByteArrayOutputStream()) {
                while ((by = in.read()) != -1) {
                    stream.write(by);
                }
                stream.flush();
                msg.buffer = stream.toByteArray();
                stream.close();
            }
        }
    }

    /**
     * Reads a line until a \r\n is encountered ( or the connection closes )
     *
     * @return
     * @throws IOException
     */
    public String readline() throws IOException {
        StringBuilder build = new StringBuilder();
        int b;
        char last = '0';
        char current;
        while (((b = in.read()) != -1)) {
            current = (char) (b & 0xFF);
            if (current == '\n') {
                if (last == '\r') {
                    break;
                }
            } else if (current != '\r') {
                build.append(current);

            }
            last = current;

        }
        return build.toString();
    }

    public final int RESPONSE = -1;
    public final int REQUEST = -2;

    /**
     * Reads a HTTP Message, type is specified by the parameter (See
     * Connection.REQUEST and Connection.RESPONSE)
     *
     * @param type
     * @return
     * @throws ParseException
     * @throws NotImplementedException
     * @throws IOException
     */
    public Message readMessage(int type) throws ParseException, NotImplementedException, IOException {
        Message parse;
        switch (type) {
            case RESPONSE:
                parse = new HttpResponse();
                break;
            case REQUEST:
                parse = new HttpRequest();
                break;
            default:
                throw new NotImplementedException("Not Implemented", 501, "Not Implemented", "");
        }
        while (!parse.done()) {
            parse.nextLine(readline());
        }

        readData(parse);
        return parse;
    }

    /**
     * Attempts to flush the outward data stream
     *
     * @throws IOException
     */
    public void flush() throws IOException {
        out.flush();
    }

    /**
     * Sends a HTTP Message to the remote host
     *
     * @param msg
     * @return
     * @throws IOException
     * @throws ParseException
     */
    public boolean send(Message msg) throws IOException, ParseException {
        out.write(msg.pack().getBytes());
        if (msg.buffer != null) {
            out.write(msg.buffer);
        }
        return true;
    }

    /**
     * Sends a line of output to the remote host
     *
     * @param output
     * @throws IOException
     */
    public void sendRaw(String output) throws IOException {
        out.write(output.getBytes());
    }

    /**
     * Attempts to open all datastreams between the two end points
     *
     * @throws IOException
     */
    public void open() throws IOException {
        if (connection == null) {
            connection = new Socket(destination, port);
        }
        if (out == null) {
            out = connection.getOutputStream();
        }
        if (in == null) {
            in = connection.getInputStream();
        }
    }

    /**
     * Returns the remote host
     *
     * @return
     */
    public String host() {
        return destination;
    }

    /**
     * Attempts to close all data streams between the two end points
     *
     * @throws IOException
     */
    public void close() throws IOException {
        if (connection.isConnected() && !connection.isClosed()) {
            out.close();
            in.close();
            connection.close();
        }
    }

}
