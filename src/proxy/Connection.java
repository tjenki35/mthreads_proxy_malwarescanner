package proxy;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

/**
 * Represents a single throw away tcp connection bewteen a client and a host
 *
 * @author Torie Jenkins u1038290
 */
public class Connection {

    public Socket connection;
    private InputStream in;
    private OutputStream out;
    private final String destination;
    private final int port;

    public Connection(String destination, int port) {
        this.destination = destination;
        this.port = port;
    }

    public Connection(Socket existing_socket) {
        connection = existing_socket;
        port = connection.getPort();
        destination = connection.getInetAddress().getHostName();
    }

    public void readData(Message msg) throws NetworkException {
        boolean checkcontent = msg.contentType != null;
        if (checkcontent) {
            int by;
            try {
                try (ByteArrayOutputStream stream = new ByteArrayOutputStream()) {
                    while ((by = in.read()) != -1) {
                        stream.write(by);
                    }
                    stream.flush();
                    msg.buffer = stream.toByteArray();
                    stream.close();
                }
            } catch (IOException ex) {
                throw new NetworkException(ex.getCause().toString() + "Can't read bits");
            }
        }
    }

    public String readline() throws IOException {
        StringBuilder build = new StringBuilder();
        int b;
        char last = '0';
        char current;
        while (((b = in.read()) != -1)) {
            current = (char) (b & 0xFF);
            if (current == '\n') {
                if (last == '\r') {
                    break;
                }
            } else if (current != '\r') {
                build.append(current);

            }
            last = current;

        }
        return build.toString();
    }

    public final int RESPONSE = -1;
    public final int REQUEST = -2;

    public Message readMessage(int type) throws ParseException, NotImplementedException, NetworkException {
        Message parse;
        switch (type) {
            case RESPONSE:
                parse = new HttpResponse();
                break;
            case REQUEST:
                parse = new HttpRequest();
                break;
            default:
                throw new NotImplementedException("Non-valid int used. ");
        }
        try {
            while (!parse.done()) {
                String str = readline();
                parse.nextLine(str);
            }
        } catch (IOException ex) {
            ex.printStackTrace();
            throw new NetworkException("Can't Write to Socket");
        }
        readData(parse);
        return parse;
    }

    public void flush() throws NetworkException {
        try {
            out.flush();
        } catch (IOException ex) {
            throw new NetworkException("can't flush out stream");
        }
    }

    public boolean send(Message msg) throws NetworkException, ParseException {
        try {
            out.write(msg.pack().getBytes());
            if (msg.buffer != null) {
                out.write(msg.buffer);
            }
        } catch (IOException ex) {
            throw new NetworkException("failed to write to stream");
        }
        return true;
    }

    public void open() throws NetworkException {
        try {
            if (connection == null) {
                connection = new Socket(destination, port);
            }
            if (out == null) {
                out = connection.getOutputStream();
            }
            if (in == null) {
                in = connection.getInputStream();
            }
        } catch (IOException ex) {
            throw new NetworkException("Attempting to open a connection to a invalid port and destination pair:\n" + destination + ":" + port + "\n");
        }
    }

    public String host() {
        return destination;
    }

    public void close() throws NetworkException {
        if (connection.isConnected()) {
            try {
                connection.close();
            } catch (IOException ex) {
                throw new NetworkException("Issue closing socket or resource");
            }
        }
    }

}
