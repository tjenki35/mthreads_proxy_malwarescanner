package proxy;

import java.io.IOException;
import java.net.InetAddress;
import java.net.Socket;
import java.net.UnknownHostException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Arrays;
import java.io.Writer;

/**
 * Represents a single HTTP session between the proxy and a client
 *
 * @author Torie Jenkins u1038290
 */
public class Process implements Runnable {

    private final Connection client;
    private final boolean verbose;
    private final boolean scanCymru;
    private final boolean xverbose;
    private final StringBuilder history = new StringBuilder();
    private Writer output;

    public Process(Socket stream, Writer out, boolean v, boolean xv, boolean cymru) {
        client = new Connection(stream);
        output = out;
        verbose = v;
        xverbose = xv;
        scanCymru = cymru;
    }

    /**
     * Runs the main processing thread
     */
    @Override
    public void run() {
        try {
            log("\n----------------Conversation(" + client.host() + ")--------------------------\n");
            HttpRequest request;
            try {
                client.open();
                request = (HttpRequest) client.readMessage(client.REQUEST);
            } catch (IOException ex) {
                throw new NetworkException("Was unable to send response back to client, client closed?", 499, "Client Closed Request");
            } //recieves message from client

            if (client.host() == null) {
                //if there is no host, no point in continuing
                return;
            }

            int port = 80; //validates ports
            if (request.port != -1) {
                port = request.port;
            }
            if (port == 443) {
                history.setLength(0);

                throw new NotImplementedException("HTTPS not supported", 501, "Not Implemented", "");
            }
            Connection connection;
            try {

                InetAddress inet = InetAddress.getByName(request.host);
                String address = inet.getHostAddress(); // todo find source
                connection = new Connection(address, port);
            } catch (NullPointerException ex) {
                throw ex;
            }//connects to remote server

            log("***Routing request from " + client.host() + " to " + connection.host() + "***\n");
            if (xverbose) {
                log(request.pack());
            }

            try {
                connection.open();
                connection.send(request);
                connection.flush();
            } catch (IOException ex) {
                throw new NetworkException("There was an error contacting the requested server", 409, "Conflict"); // no server response
            } // sends request on behalf of client
            
            HttpResponse response;
            try {
                response = (HttpResponse) connection.readMessage(connection.RESPONSE);
                connection.close();
            } catch (IOException ex) {
                throw new NetworkException("Recieved an invalid response from target resource", 502, "Bad Gateway");
            }
            //recieves reponse from the remote server
            
            if (scanCymru) { // scan for any potential malware in given object
                try {
                    if (response.buffer != null) {
                        StringBuilder output_sha = new StringBuilder();
                        byte[] hash_sha;
                        try {
                            hash_sha = MessageDigest.getInstance("SHA1").digest(response.buffer);
                            for (byte b : hash_sha) {
                                String hex = Integer.toHexString(0xFF & b); // convert to hex ( I wonder if I can just send straight bytes to the service
                                if (hex.length() == 1) {
                                    output_sha.append('0');
                                }
                                output_sha.append(hex); // generate sha1 hash string (less issues)
                            }
                        } catch (NoSuchAlgorithmException ex) {
                            printErr(ex.getLocalizedMessage());
                        }
                        Connection cymru = new Connection("hash.cymru.com", 43);
                        cymru.open();
                        cymru.sendRaw(output_sha.toString()+"\n"); // <-- right here this line should be cymru.sendRaw(output_sha.toString()+"\n");
                        cymru.flush(); 
                        String answer = cymru.readline();
                        cymru.close(); //thanks guys!
                        if (!answer.contains("NO_DATA")||answer.length()==0) { 
                            //something has gone awry
                            Arrays.fill(response.buffer, (byte) 0); 
                            response.buffer = null; // I mean cmon
                            response.headers.clear();
                            response.status=301;
                            response.reasonPhrase="Moved Permanently";
                            char quote  = '"';
                            response.headers.add("Location: "+"https://www.google.com/search?q="+quote+output_sha.toString()+quote);
                        } // else continue to deliver content
                        log("Cymru says: " + answer + "\n");
                    } else {
                        log("\n***No Object to Hash***\n");
                    }
                } catch (IOException ex) {
                    printErr("TEAM CYMRU RESOURCE NOT AVAILABLE: proceed with caution");
                }
            }
            try {
                client.send(response);
                client.flush();

            } catch (IOException ex) {
                log("Was unable to send response back to client, client closed?");
            }
            log("***Routing reply from " + connection.host() + " to " + client.host() + "***\n");
            if (xverbose) {
                log(response.pack());
            }
            log("-------------------------------------------------------------------\n\n");

        } catch (HttpException ex) {
            String tcp = "Tcp session closed from client side";
            log(ex.getMessage());
            printErr(tcp);
            if (client.isAlive()) {
                try {
                    client.send(ex.pack());
                } catch (IOException netex) {
                    if (xverbose) {
                        printErr(tcp);
                    }
                } catch (ParseException parsex) {
                    printErr("Program Erorr : Call Me");
                }
            } else {
                printErr(tcp);
            }
        } catch (UnknownHostException ex) { // for more detailed exception handling it could be sufficient to handle each network exception independently from source and
            printErr(ex.getMessage());
        } finally {
            if (history.length() > 0) {
                print(history.toString());
            }
            try {
                client.flush();
                client.close();
            } catch (IOException ex) {
                printErr(ex.getMessage());
            }
        }
    }

    private void println(String line){
        try{
            output.write(line);
            output.write('\n');
            output.flush();
        }catch(IOException ex){
            System.err.println("Cannot write to log file: reason: "+ex.getMessage());
        }

    }


    private void print(String message) {
        if (verbose) {
            println(message);
        }
    }

    private void printErr(String message) {
        if (xverbose) {
            println(message);
        }
    }

    private void log(String message) {
        if (verbose) {
            history.append(message);
        }
    }
}
